name: Release theme
on:
  release:
    types: [published]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v2
      with:
        lfs: true
    - name: Install libvips
      run: |
        sudo apt-get install -yqq libvips-tools
    - name: Install puppeteer dependencies
      run: |
        sudo apt-get install -yqq libgconf-2-4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: .ruby-version

    # Caches
    - name: bundler cache
      uses: actions/cache@v1
      with:
        path: vendor/bundle
        key: ${{ runner.os }}-${{ hashFiles( '.ruby-version' ) }}-gems-${{ hashFiles( '**/Gemfile.lock' ) }}
      # require strict cache hit, otherwise we get some Illegal Instruction errors

    - name: Use Node.js 16.x
      uses: actions/setup-node@v2
      with:
        node-version: 16.x
        registry-url: https://registry.npmjs.org/


    - name: npm cache
      uses: actions/cache@v1
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node16-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node16-

    # Dependencies

    - name: get gem dependencies
      run: |
        gem install bundler
        bundle config path vendor/bundle
        bundle config set with 'test'
        bundle install --jobs 4 --retry 3
    - name: get npm dependencies
      run:
        npm ci

    # Build
    - name: create _deploy.yml config file
      run: |
        echo "env: production" > _deploy.yml
        echo "url: https://holusion.com" >> _deploy.yml
        echo "build_id: '$GITHUB_RUN_ID'" >> _deploy.yml
        echo "snipcart_api_key: 'MTA0ZmUzN2EtNGFlZS00NjZkLWFiZDktM2RlNzUyODgzMDBhNjM2MTQzNjEyNzYwNDkzMDM2'" >> _deploy.yml
    - name: build
      run: |
        ./build.sh
    - name: deploy to npmjs.org
      run: |
        npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
